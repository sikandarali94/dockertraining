version: 2.1
jobs:
  before-install:
    machine: true
    steps:
      - checkout
      - run:
          name: Build Docker Dev Image
          command: |
            docker build -t siky98/docker-training-dev -f Dockerfile.dev .
      - run:
          name: Run Tests
          command: |
            docker run -e CI=true siky98/docker-training-dev npm run test -- --coverage
      - run:
          name: Build Docker Prod Image
          command: |
            docker build -t siky98/docker-training-prod .
      - run:
          name: Cache Docker Image In Workspace
          command: |
            mkdir -p docker-workspace
            docker save -o docker-workspace/docker-training.tar siky98/docker-training-prod
      - persist_to_workspace:
            root: docker-workspace
            paths:
              - docker-training.tar
  deploy:
    machine: true
    steps:
      - attach_workspace:
          at: /tmp/docker-workspace
      - run:
          name: Load Docker Image
          command: |
            docker load < /tmp/docker-workspace/docker-training.tar
      - run:
          name: Lists Docker Images
          command: |
            docker image ls
workflows:
  deploy-server:
    jobs:
      - before-install
      - deploy:
          requires:
            - before-install